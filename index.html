<!DOCTYPE html>
<html>
<head>
    <title>SATE Download JSON</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.81.1/dist/L.Control.Locate.min.css" />
</head>
<body>
    <div id="map" ></div>
    <button id="downloadButton">Download JSON</button>
    <div id="buttons">
        <button id="drawProjectArea"><i class="fas fa-draw-polygon"></i> Teken Projectgebied</button>
        <button id="drawStartEndPoint"><i class="fas fa-map-marker-alt"></i> Teken Start/Eind Punten</button>
        <button id="drawNoGoZone"><i class="fas fa-ban"></i> Teken No-Go Zones</button>
        <button id="drawHulplijn"><i class="fas fa-route"></i> Teken Hulplijnen</button>
        <button id="drawBoorlijn"><i class="fas fa-road"></i> Teken Boorlijnen</button>
    </div>
    <div id="popup">
        <h3>Download Gelukt!</h3>
        <p>Stuur de JSON naar het volgende email adres voor het maken van een tracé: <span id="email-link"></span>.</p>
        <button id="closePopup">Close</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turf.js/5.1.6/turf.min.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.81.1/dist/L.Control.Locate.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" ></script>
    <script>
        // Initialize the map
        var map = L.map("map").setView([52.2354, 5.3751], 7);
        var tileLayer = L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            {
                attribution:
                    '&copy; <a href="https://www.openstreetmap.org/copyright">',
            }
        ).addTo(map);

        // add search bar
        L.Control.geocoder().addTo(map);

        // FeatureGroup to store editable layers
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Initialize the draw control and pass it the FeatureGroup of editable layers
        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: false // Disable default draw tools
        });
        map.addControl(drawControl);

        // Add created layers to the map
        map.on(L.Draw.Event.CREATED, function (event) {
            var layer = event.layer;
            drawnItems.addLayer(layer);
            layer.type = currentDrawingType; // Set type to distinguish different drawing types
        });


        var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });


        var currentDrawingType = null;
        var drawControlProjectArea = new L.Draw.Polygon(map, {
            shapeOptions: {
                color: 'blue',
                fill: false
            }
        });
        
var drawControlStartEndPoint = new L.Draw.Marker(map, {
    icon: redIcon
});
        var drawControlNoGoZone = new L.Draw.Polygon(map, {
            shapeOptions: {
                color: 'red'
            }
        });
        var drawControlHulplijn = new L.Draw.Polyline(map, {
            shapeOptions: {
                color: 'orange'
            }
        });

        var drawControlBoorlijn = new L.Draw.Polyline(map, {
            shapeOptions: {
                color: 'black'
            }
        });


        document.getElementById('drawProjectArea').addEventListener('click', function () {
            currentDrawingType = 'projectgebiedWKT';
            drawControlProjectArea.enable();
        });

        document.getElementById('drawStartEndPoint').addEventListener('click', function () {
            currentDrawingType = 'startEindPuntWKT';
            drawControlStartEndPoint.enable();
        });

        document.getElementById('drawNoGoZone').addEventListener('click', function () {
            currentDrawingType = 'nogoZonesWKT';
            drawControlNoGoZone.enable();
        });

        document.getElementById('drawHulplijn').addEventListener('click', function () {
            currentDrawingType = 'hulplijnenWKT';
            drawControlHulplijn.enable();
        });

        document.getElementById('drawBoorlijn').addEventListener('click', function () {
            currentDrawingType = 'boorlijnenWKT';
            drawControlBoorlijn.enable();
        });

        // Coordinate transformation
        proj4.defs([
            ['EPSG:4326', '+proj=longlat +datum=WGS84 +no_defs'],
            ['EPSG:28992', '+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +towgs84=565.4171,50.3319,465.5524,0.398957,0.343988,-1.8774,4.0725 +no_defs']
        ]);

        function toRDNew(lat, lng) {
            return proj4('EPSG:4326', 'EPSG:28992', [lng, lat]);
        }

        // Function to convert coordinates to WKT format in RD New
        function toWKT(layer) {
            if (layer instanceof L.Polygon) {
                var coords = layer.getLatLngs()[0].map(function (latLng) {
                    var rdCoords = toRDNew(latLng.lat, latLng.lng);
                    return rdCoords[0] + ' ' + rdCoords[1];
                }).join(', ');
                // Ensure the polygon is closed
                coords += ', ' + coords.split(', ')[0]; 
                return 'POLYGON ((' + coords + '))';
            } else if (layer instanceof L.Polyline) {
                var coords = layer.getLatLngs().map(function (latLng) {
                    var rdCoords = toRDNew(latLng.lat, latLng.lng);
                    return rdCoords[0] + ' ' + rdCoords[1];
                }).join(', ');
                return 'LINESTRING (' + coords + ')';
            } else if (layer instanceof L.Marker) {
                var rdCoords = toRDNew(layer.getLatLng().lat, layer.getLatLng().lng);
                return 'POINT (' + rdCoords[0] + ' ' + rdCoords[1] + ')';
            }
        }

        // Function to download GeoJSON
        function downloadGeoJSON() {
            var projectgebiedWKT = null;
            var startEindPuntWKT = [];
            var nogoZonesWKT = [];
            var hulplijnenWKT = [];
            var boorlijnenWKT = [];

            drawnItems.eachLayer(function (layer) {
                var wkt = toWKT(layer);
                if (layer.type === 'projectgebiedWKT') {
                    projectgebiedWKT = wkt;
                } else if (layer.type === 'startEindPuntWKT') {
                    startEindPuntWKT.push(wkt);
                } else if (layer.type === 'nogoZonesWKT') {
                    nogoZonesWKT.push(wkt);
                } else if (layer.type === 'hulplijnenWKT') {
                    hulplijnenWKT.push(wkt);
                } else if (layer.type === 'boorlijnenWKT') {
                    boorlijnenWKT.push(wkt);
                }
            });

            if (!projectgebiedWKT || startEindPuntWKT.length === 0) {
                alert("Het tekenen van een projectgebied en op zijn minst één start en één eindpunt is verplicht.");
                return;
            }

            var projectName = prompt("Voer een projectnaam in:");
            projectName = projectName.replace(/[^a-zA-Z0-9]/g, '_');
            if (!projectName || projectName.trim() === '') {
                alert("Projectnaam is verplicht.");
                return;
            }

            var geoJSONData = {
                projectgebiedWKT: projectgebiedWKT,
                startEindPuntWKT: startEindPuntWKT,
                nogoZonesWKT: nogoZonesWKT,
                hulplijnenWKT: hulplijnenWKT,
                boorlijnenWKT: boorlijnenWKT
            };

            var blob = new Blob([JSON.stringify(geoJSONData, null, 2)], { type: "application/json" });
            saveAs(blob, projectName + ".json");

            document.getElementById("popup").style.display = "block";
        }

        document.getElementById('downloadButton').addEventListener('click', downloadGeoJSON);

        document.getElementById('closePopup').addEventListener('click', function() {
            document.getElementById('popup').style.display = 'none';
        });
        
        // add current location locator button
        L.control.locate().addTo(map);

        // invisible email
        (function() {
            const user = 'smartengineering-klm'; // Replace with the actual username part of the email
            const domain = 'vangelder'; // Replace with the actual domain part of the email
            var tld = 'com';
            const email = user + '@' + domain + '.' + tld;
            const emailLink = document.getElementById('email-link');

            // Set the email address as the text content of the span
            emailLink.textContent = email;

            // Make the email a clickable mailto link
            emailLink.innerHTML = `<a href="mailto:${email}">${email}</a>`;
        })();

        // JavaScript to handle the close button
        document.getElementById('closePopup').addEventListener('click', function() {
            document.getElementById('popup').style.display = 'none';
        });

        // add map scale
        L.control.scale().addTo(map);

        // add map coorrdinate display
        map.on('contextmenu', function(e) {
            const { lat, lng } = e.latlng;
            const rdCoords = toRDNew(lat, lng);
            const popupContent = `
                <div>
                    <strong>RD Coordinates</strong><br>
                    X: ${rdCoords[0]}<br>
                    y: ${rdCoords[1]}
                </div>
            `;
            L.popup()
                .setLatLng(e.latlng)
                .setContent(popupContent)
                .openOn(map);
            });
        
    </script>
</body>
</html>
